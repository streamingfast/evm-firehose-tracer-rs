version: "3.9"

# Monad Localnet with Extended Blocks Firehose
# Chain ID: 20143
#
# Prerequisites:
# 1. Build the image: docker build -f Dockerfile.localnet -t monad-localnet-extended .
# 2. Set system parameters (as root):
#    sysctl -w vm.nr_hugepages=2048
#    sysctl -w net.core.rmem_max=62500000
#    sysctl -w net.core.rmem_default=62500000
#    sysctl -w net.core.wmem_max=62500000
#    sysctl -w net.core.wmem_default=62500000
# 3. Create hugepages directory: mkdir -p /dev/hugepages/monad-localnet
# 4. Run: docker-compose -f docker-compose-localnet.yml up -d
#
# Test RPC: curl -X POST http://localhost:8080 -H "Content-Type: application/json" \
#           --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}'
# Expected: {"jsonrpc":"2.0","result":"0x4eaf","id":1}

services:
  # Monad Consensus (BFT)
  consensus:
    image: monad-localnet-extended
    container_name: monad-localnet-consensus
    command:
      - /app/monad-node
      - --chain-id=20143
      - --node-config=/data/config/node.toml
      - --keystore-path=/data/config/id-secp
      - --bls-keystore-path=/data/config/id-bls
      - --keystore-password=localnet-dev-password-do-not-use-in-production
      - --log_level=INFO
    volumes:
      - ./localnet-data:/data
      - /dev/hugepages/monad-localnet:/dev/hugepages/monad-localnet
    environment:
      LD_LIBRARY_PATH: /usr/local/lib
    ports:
      - "8000:8000"  # BFT P2P port
    privileged: true
    networks:
      - monad-localnet

  # Monad Execution
  execution:
    image: monad-localnet-extended
    container_name: monad-localnet-execution
    command:
      - /app/monad
      - --chain-id=20143
      - --execution-data-dir=/data/ledger
      - --exec-event-ring=/dev/hugepages/monad-localnet/monad-events
      - --buffer-size=524288
      - --log_level=INFO
    volumes:
      - ./localnet-data:/data
      - /dev/hugepages/monad-localnet:/dev/hugepages/monad-localnet
    environment:
      LD_LIBRARY_PATH: /usr/local/lib
    privileged: true
    depends_on:
      - consensus
    networks:
      - monad-localnet

  # Monad RPC
  rpc:
    image: monad-localnet-extended
    container_name: monad-localnet-rpc
    command:
      - /app/monad-rpc
      - --node-config=/data/config/node.toml
      - --rpc-addr=0.0.0.0
      - --rpc-port=8080
      - --log_level=INFO
    volumes:
      - ./localnet-data:/data
    environment:
      LD_LIBRARY_PATH: /usr/local/lib
    ports:
      - "8080:8080"  # JSON-RPC port
    depends_on:
      - consensus
      - execution
    networks:
      - monad-localnet

  # Firehose with Extended Blocks Tracer
  firehose:
    image: monad-localnet-extended
    container_name: monad-localnet-firehose
    entrypoint: ["/app/fireeth"]
    command:
      - start
      - reader-node
      - --config-file=
      - --log-to-file=false
      - --data-dir=/data/firehose
      - --common-first-streamable-block=0
      - --common-one-block-store-url=file:///data/firehose/one-blocks
      - --reader-node-path=/app/monad-firehose-tracer
      - --reader-node-data-dir=/data/firehose/reader
      - --reader-node-working-dir=/data/firehose/work
      - --reader-node-grpc-listen-addr=:9000
      - --reader-node-manager-api-addr=:8081
      - --reader-node-bootstrap-data-url=
      - --reader-node-blocks-chan-capacity=1000
      - --reader-node-one-block-suffix=monad-localnet
      - --reader-node-arguments=--chain-id=20143 --network-name=monad-localnet --monad-event-ring-path=/dev/hugepages/monad-localnet/monad-events --buffer-size=524288
      - --metrics-listen-addr=:9102
    volumes:
      - ./localnet-data:/data
      - /dev/hugepages/monad-localnet:/dev/hugepages/monad-localnet
    environment:
      RUST_LOG: info
      LD_LIBRARY_PATH: /usr/local/lib
    ports:
      - "9000:9000"  # Firehose gRPC
      - "9102:9102"  # Metrics
    privileged: true
    depends_on:
      - consensus
      - execution
    networks:
      - monad-localnet

  # Firehose API (optional - provides Firehose gRPC API)
  firehose-api:
    image: monad-localnet-extended
    container_name: monad-localnet-firehose-api
    entrypoint: ["/app/fireeth"]
    command:
      - start
      - firehose
      - --config-file=
      - --log-to-file=false
      - --data-dir=/data/firehose
      - --common-first-streamable-block=0
      - --common-live-blocks-addr=firehose:9000
      - --firehose-grpc-listen-addr=:9001
      - --metrics-listen-addr=:9103
    volumes:
      - ./localnet-data:/data
    environment:
      LD_LIBRARY_PATH: /usr/local/lib
    ports:
      - "9001:9001"  # Firehose API gRPC
      - "9103:9103"  # Metrics
    depends_on:
      - firehose
    networks:
      - monad-localnet

networks:
  monad-localnet:
    driver: bridge
